From 3ee06692c7cd14b1d4e5d89691d82dbf94e9d059 Mon Sep 17 00:00:00 2001
From: cpchiang <cpchiang1@nuvoton.com>
Date: Wed, 20 Sep 2023 10:29:58 +0800
Subject: [PATCH 2/3] mctp i3c: add disable calculate pec config

add disable calculate pec config.

Signed-off-by: cpchiang <cpchiang1@nuvoton.com>
---
 drivers/net/mctp/Kconfig    |  9 +++++++++
 drivers/net/mctp/mctp-i3c.c | 14 +++++++++++++-
 2 files changed, 22 insertions(+), 1 deletion(-)

diff --git a/drivers/net/mctp/Kconfig b/drivers/net/mctp/Kconfig
index ce9d2d2ccf3b..07bd05872c93 100644
--- a/drivers/net/mctp/Kconfig
+++ b/drivers/net/mctp/Kconfig
@@ -42,6 +42,15 @@ config MCTP_TRANSPORT_I3C
 	  A MCTP protocol network device is created for each I3C bus
 	  having a "mctp-controller" devicetree property.
 
+config MCTP_TRANSPORT_I3C_PEC
+	tristate "MCTP I3C transport support PEC"
+	depends on MCTP_TRANSPORT_I3C
+	default y
+	help
+	  Some mctp i3c devices disable PEC check since it cost much time to
+	  calculate the result of PEC.
+	  Provides a choice to enable/disable append pec byte.
+
 endmenu
 
 endif
diff --git a/drivers/net/mctp/mctp-i3c.c b/drivers/net/mctp/mctp-i3c.c
index d1bd1d83aee2..69238a9fd135 100644
--- a/drivers/net/mctp/mctp-i3c.c
+++ b/drivers/net/mctp/mctp-i3c.c
@@ -154,6 +154,7 @@ static int mctp_i3c_read(struct mctp_i3c_device *mi)
 		goto err;
 	}
 
+#ifdef CONFIG_MCTP_TRANSPORT_I3C_PEC
 	/* check PEC, including address byte */
 	addr = mi->addr << 1 | 1;
 	pec = i2c_smbus_pec(0, &addr, 1);
@@ -166,6 +167,9 @@ static int mctp_i3c_read(struct mctp_i3c_device *mi)
 
 	/* Remove PEC */
 	skb_trim(skb, xfer.len - 1);
+#else
+	skb_trim(skb, xfer.len);
+#endif
 
 	cb = __mctp_cb(skb);
 	cb->halen = PID_SIZE;
@@ -175,7 +179,11 @@ static int mctp_i3c_read(struct mctp_i3c_device *mi)
 
 	if (net_status == NET_RX_SUCCESS) {
 		stats->rx_packets++;
+#ifdef CONFIG_MCTP_TRANSPORT_I3C_PEC
 		stats->rx_bytes += xfer.len - 1;
+#else
+		stats->rx_bytes += xfer.len;
+#endif
 	} else {
 		stats->rx_dropped++;
 	}
@@ -409,6 +417,7 @@ static void mctp_i3c_xmit(struct mctp_i3c_bus *mbus, struct sk_buff *skb)
 		goto out;
 	}
 
+#ifdef CONFIG_MCTP_TRANSPORT_I3C_PEC
 	/* Need a linear buffer with space for the PEC */
 	xfer.len = data_len + 1;
 	if (skb_tailroom(skb) >= 1) {
@@ -426,8 +435,11 @@ static void mctp_i3c_xmit(struct mctp_i3c_bus *mbus, struct sk_buff *skb)
 	pec = i2c_smbus_pec(0, &addr, 1);
 	pec = i2c_smbus_pec(pec, data, data_len);
 	data[data_len] = pec;
-
 	xfer.data.out = data;
+#else
+	xfer.len = data_len;
+	xfer.data.out = skb->data;
+#endif
 	rc = i3c_device_do_priv_xfers(mi->i3c, &xfer, 1);
 	if (rc == 0) {
 		stats->tx_bytes += data_len;
-- 
2.17.1


From c8e61ec28dd2c93eda5e23dd3534e056d532cbd1 Mon Sep 17 00:00:00 2001
From: Marvin Lin <milkfafa@gmail.com>
Date: Fri, 12 Aug 2022 17:06:51 +0800
Subject: [PATCH] support CPLD UART 16450

---
 .../dts/nuvoton/nuvoton-common-npcm8xx.dtsi   |  8 +++
 .../boot/dts/nuvoton/nuvoton-npcm845-evb.dts  | 50 ++++++++++++++++++-
 .../nuvoton/nuvoton-npcm845-pincfg-evb.dtsi   |  5 ++
 3 files changed, 62 insertions(+), 1 deletion(-)

diff --git a/arch/arm64/boot/dts/nuvoton/nuvoton-common-npcm8xx.dtsi b/arch/arm64/boot/dts/nuvoton/nuvoton-common-npcm8xx.dtsi
index 7548a3f0f45e..3e1ced523a5e 100644
--- a/arch/arm64/boot/dts/nuvoton/nuvoton-common-npcm8xx.dtsi
+++ b/arch/arm64/boot/dts/nuvoton/nuvoton-common-npcm8xx.dtsi
@@ -1133,6 +1133,14 @@
 			gpio-ranges = <&pinctrl 0 0 32>;
 		};
 		gpio1: gpio@f0011000 {
+			interrupt-controller;
+			#interrupt-cells = <2>;
+			gpio-line-names =
+			"","","","","","","","",
+			"","","","","","","","",
+			"","","","","","","","",
+			"","","","","","","","";
+
 			gpio-controller;
 			#gpio-cells = <2>;
 			reg = <0x1000 0xB0>;
diff --git a/arch/arm64/boot/dts/nuvoton/nuvoton-npcm845-evb.dts b/arch/arm64/boot/dts/nuvoton/nuvoton-npcm845-evb.dts
index 1fb364b4c302..6d062a47d3ef 100644
--- a/arch/arm64/boot/dts/nuvoton/nuvoton-npcm845-evb.dts
+++ b/arch/arm64/boot/dts/nuvoton/nuvoton-npcm845-evb.dts
@@ -16,6 +16,10 @@
 		serial1 = &serial1;
 		serial2 = &serial2;
 		serial3 = &serial3;
+		serial4 = &cpld_serial0;
+		serial5 = &cpld_serial1;
+		serial6 = &cpld_serial2;
+		serial7 = &cpld_serial3;
 		ethernet0 = &gmac0;
 		ethernet1 = &gmac1;
 		ethernet2 = &gmac2;
@@ -289,6 +293,50 @@
 
 		fiux: spi@fb001000 {
 			spix-mode;
+			//nuvoton,spix-mode;
+			pinctrl-names = "default";
+			pinctrl-0 = <&spix_pins>;
+			status = "okay";
+		};
+
+		cpld_serial0: cpld_uart@f8000800 {
+			device_type = "serial";
+			compatible = "ns16450";
+			reg = <0x0 0xf8000800 0x0 0x200>;
+			reg-shift = <0>;
+			clocks = <&clk NPCM8XX_CLK_UART>;
+			interrupt-parent = <&gpio1>;
+			interrupts = <15 IRQ_TYPE_EDGE_FALLING>;
+		};
+
+		cpld_serial1: cpld_uart@f8000a00 {
+			device_type = "serial";
+			compatible = "ns16450";
+			reg = <0x0 0xf8000a00 0x0 0x200>;
+			reg-shift = <0>;
+			clocks = <&clk NPCM8XX_CLK_UART>;
+			interrupt-parent = <&gpio1>;
+			interrupts = <15 IRQ_TYPE_EDGE_FALLING>;
+		};
+
+		cpld_serial2: cpld_uart@f8000c00 {
+			device_type = "serial";
+			compatible = "ns16450";
+			reg = <0x0 0xf8000c00 0x0 0x200>;
+			reg-shift = <0>;
+			clocks = <&clk NPCM8XX_CLK_UART>;
+			interrupt-parent = <&gpio1>;
+			interrupts = <15 IRQ_TYPE_EDGE_FALLING>;
+		};
+
+		cpld_serial3: cpld_uart@f8000e00 {
+			device_type = "serial";
+			compatible = "ns16450";
+			reg = <0x0 0xf8000e00 0x0 0x200>;
+			reg-shift = <0>;
+			clocks = <&clk NPCM8XX_CLK_UART>;
+			interrupt-parent = <&gpio1>;
+			interrupts = <15 IRQ_TYPE_EDGE_FALLING>;
 		};
 
 		ehci1: usb@f0828100 {
@@ -569,13 +617,13 @@
 				&tp_jtag3_pins
 				&lpc_pins
 				&pin70_o
+				&pin47
 				&pin108_slew
 				&pin109_slew
 				&pin240_slew
 				&pin241_slew
 				&pin242_slew
 				&pin243_slew
-				&spix_pins
 				&pin17_slew
 				&pin18_slew
 				&pin19_slew
diff --git a/arch/arm64/boot/dts/nuvoton/nuvoton-npcm845-pincfg-evb.dtsi b/arch/arm64/boot/dts/nuvoton/nuvoton-npcm845-pincfg-evb.dtsi
index 52665c5a1ba1..5de58c25054d 100644
--- a/arch/arm64/boot/dts/nuvoton/nuvoton-npcm845-pincfg-evb.dtsi
+++ b/arch/arm64/boot/dts/nuvoton/nuvoton-npcm845-pincfg-evb.dtsi
@@ -3,6 +3,11 @@
 
 / {
 	pinctrl: pinctrl@f0800000 {
+		pin47: pin47 {
+			pins = "GPIO47/SI1n_RI1";
+			bias-disable;
+			input-enable;
+		};
 		pin70_o: pin70-o {
 			 pins = "GPIO70/FANIN6";
 			 bias-disable;
-- 
2.17.1


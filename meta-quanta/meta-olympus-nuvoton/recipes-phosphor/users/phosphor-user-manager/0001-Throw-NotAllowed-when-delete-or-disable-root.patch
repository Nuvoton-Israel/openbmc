From 939067d91febed1052c281bafa845f067f149ba5 Mon Sep 17 00:00:00 2001
From: Brian Ma <chma0@nuvoton.com>
Date: Fri, 25 Mar 2022 16:28:25 +0800
Subject: [PATCH] Throw NotAllowed when delete or disable root

Throw NotAllowed execption when try to delete or disable root instead of
throw InternalFailure execption.

Signed-off-by: Brian Ma <chma0@nuvoton.com>
Signed-off-by: Allen Kang <jhkang@nuvoton.com>

Change-Id: I32430ab376c584ef7e4eec88cf604e00bfc6f415
---
 user_mgr.cpp | 14 ++++++++++++++
 user_mgr.hpp |  7 +++++++
 2 files changed, 21 insertions(+)

diff --git a/user_mgr.cpp b/user_mgr.cpp
index f4a90ec..099b2d1 100644
--- a/user_mgr.cpp
+++ b/user_mgr.cpp
@@ -92,6 +92,7 @@ using InternalFailure =
     sdbusplus::xyz::openbmc_project::Common::Error::InternalFailure;
 using InvalidArgument =
     sdbusplus::xyz::openbmc_project::Common::Error::InvalidArgument;
+using NotAllowed = sdbusplus::xyz::openbmc_project::Common::Error::NotAllowed;
 using UserNameExists =
     sdbusplus::xyz::openbmc_project::User::Common::Error::UserNameExists;
 using UserNameDoesNotExist =
@@ -101,6 +102,7 @@ using UserNameGroupFail =
 using NoResource =
     sdbusplus::xyz::openbmc_project::User::Common::Error::NoResource;
 using Argument = xyz::openbmc_project::Common::InvalidArgument;
+using NotAllowedReason = xyz::openbmc_project::Common::NotAllowed;
 using GroupNameExists =
     sdbusplus::xyz::openbmc_project::User::Common::Error::GroupNameExists;
 using GroupNameDoesNotExists =
@@ -230,6 +232,15 @@ void UserMgr::throwForUserExists(const std::string& userName)
     }
 }
 
+void UserMgr::throwForNotAllowRoot(const std::string& userName)
+{
+    if (userName == "root")
+    {
+        elog<NotAllowed>(
+            NotAllowedReason::REASON("Operation is not allow for root"));
+    }
+}
+
 void UserMgr::throwForUserNameConstraints(
     const std::string& userName, const std::vector<std::string>& groupNames)
 {
@@ -393,6 +404,7 @@ void UserMgr::deleteUser(std::string userName)
     // All user management lock has to be based on /etc/shadow
     // TODO  phosphor-user-manager#10 phosphor::user::shadow::Lock lock{};
     throwForUserDoesNotExist(userName);
+    throwForNotAllowRoot(userName);
     try
     {
         executeUserDelete(userName.c_str());
@@ -766,6 +778,8 @@ void UserMgr::userEnable(const std::string& userName, bool enabled)
     // All user management lock has to be based on /etc/shadow
     // TODO  phosphor-user-manager#10 phosphor::user::shadow::Lock lock{};
     throwForUserDoesNotExist(userName);
+    if (!enabled)
+        throwForNotAllowRoot(userName);
     try
     {
         executeUserModifyUserEnable(userName.c_str(), enabled);
diff --git a/user_mgr.hpp b/user_mgr.hpp
index ec205e4..29be825 100644
--- a/user_mgr.hpp
+++ b/user_mgr.hpp
@@ -299,6 +299,13 @@ class UserMgr : public Ifaces
      */
     void throwForUserExists(const std::string& userName);
 
+    /** @brief avoid not allow operation for root
+     *  method to check whether user is root, and throw if is.
+     *
+     *  @param[in] userName - name of the user
+     */
+    void throwForNotAllowRoot(const std::string& userName);
+
     /** @brief check user name constraints
      *  method to check user name constraints and throw if failed.
      *
-- 
2.34.1


From 1cdf8d55f49a40ce042ec647b1a244cbd8e724b6 Mon Sep 17 00:00:00 2001
From: Tim Lee <timlee660101@gmail.com>
Date: Fri, 29 Oct 2021 13:58:04 +0800
Subject: [PATCH 3/3] Redfish Add power metrics support

Signed-off-by: Tim Lee <timlee660101@gmail.com>
---
 redfish-core/lib/power.hpp   | 75 ++++++++++++++++++++++++++++++++++++
 redfish-core/lib/sensors.hpp |  2 +-
 2 files changed, 76 insertions(+), 1 deletion(-)

diff --git a/redfish-core/lib/power.hpp b/redfish-core/lib/power.hpp
index bf332502c..9a5f34c5c 100644
--- a/redfish-core/lib/power.hpp
+++ b/redfish-core/lib/power.hpp
@@ -299,6 +299,81 @@ inline void requestRoutesPower(App& app)
                             // be null if the limit is not enabled.
                             value = powerCap * std::pow(10, scale);
                         }
+
+                        auto PowerMetricHandler =
+                        [sensorAsyncResp](
+                            const boost::system::error_code ec,
+                            const std::vector<std::pair<std::string, SensorVariant>>&
+                                properties) {
+                            if (ec)
+                            {
+                                messages::internalError(sensorAsyncResp->asyncResp->res);
+                                BMCWEB_LOG_ERROR
+                                    << "Power Metric GetAll handler: Dbus error " << ec;
+                                return;
+                            }
+                            nlohmann::json& tempArray =
+                                sensorAsyncResp->asyncResp->res.jsonValue["PowerControl"];
+                            nlohmann::json& sensorJson = tempArray.back();
+                            for (const std::pair<std::string, SensorVariant>& property :
+                                properties)
+                            {
+                                if (!property.first.compare("IntervalInMin"))
+                                {
+                                    const uint64_t* i =
+                                    std::get_if<uint64_t>(
+                                        &property.second);
+
+                                    if (i)
+                                    {
+                                        nlohmann::json& value =
+                                            sensorJson["PowerMetrics"]["IntervalInMin"];
+                                        value = *i;
+                                    }
+                                }
+                                else if (!property.first.compare("MinConsumedWatts"))
+                                {
+                                    const uint16_t* i =
+                                    std::get_if<uint16_t>(
+                                        &property.second);
+                                    if (i)
+                                    {
+                                        nlohmann::json& value =
+                                            sensorJson["PowerMetrics"]["MinConsumedWatts"];
+                                        value = *i;
+                                    }
+                                }
+                                else if (!property.first.compare("MaxConsumedWatts"))
+                                {
+                                    const uint16_t* i =
+                                    std::get_if<uint16_t>(
+                                        &property.second);
+                                    if (i)
+                                    {
+                                        nlohmann::json& value =
+                                            sensorJson["PowerMetrics"]["MaxConsumedWatts"];
+                                        value = *i;
+                                    }
+                                }
+                                else if (!property.first.compare("AverageConsumedWatts"))
+                                {
+                                    const uint16_t* i =
+                                    std::get_if<uint16_t>(
+                                        &property.second);
+                                    if (i)
+                                    {
+                                        nlohmann::json& value =
+                                            sensorJson["PowerMetrics"]["AverageConsumedWatts"];
+                                        value = *i;
+                                    }
+                                }
+                            }
+                        };
+                        crow::connections::systemBus->async_method_call(
+                            std::move(PowerMetricHandler), "xyz.openbmc_project.NodeManagerProxy",
+                            "/xyz/openbmc_project/Power/PowerMetric",
+                            "org.freedesktop.DBus.Properties", "GetAll",
+                            "xyz.openbmc_project.Power.PowerMetric");
                     };
 
                     crow::connections::systemBus->async_method_call(
diff --git a/redfish-core/lib/sensors.hpp b/redfish-core/lib/sensors.hpp
index f9d806b89..9dd858be0 100644
--- a/redfish-core/lib/sensors.hpp
+++ b/redfish-core/lib/sensors.hpp
@@ -36,7 +36,7 @@ using GetSubTreeType = std::vector<
               std::vector<std::pair<std::string, std::vector<std::string>>>>>;
 
 using SensorVariant =
-    std::variant<int64_t, double, uint32_t, bool, std::string>;
+    std::variant<int64_t, double, uint16_t, uint32_t, uint64_t, bool, std::string>;
 
 using ManagedObjectsVectorType = std::vector<std::pair<
     sdbusplus::message::object_path,
-- 
2.17.1

